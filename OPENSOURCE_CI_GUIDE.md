# å¼€æºé¡¹ç›® CI ä¼˜åŒ–æŒ‡å—

## ğŸ¯ **å¼€æºé¡¹ç›® CI ä¼˜åŒ–ç›®æ ‡**

ä¸ç§æœ‰é¡¹ç›®ä¸åŒï¼Œå¼€æºé¡¹ç›®çš„ CI ä¼˜åŒ–é‡ç‚¹æ˜¯ï¼š

- âœ… **å¿«é€Ÿåé¦ˆ** - è®©è´¡çŒ®è€…å¿«é€Ÿè·å¾—ä»£ç è´¨é‡åé¦ˆ
- âœ… **å…¨é¢è¦†ç›–** - ç¡®ä¿å¤šå¹³å°ã€å¤šç‰ˆæœ¬å…¼å®¹æ€§
- âœ… **ç¤¾åŒºå‹å¥½** - æ¸…æ™°çš„é”™è¯¯ä¿¡æ¯å’ŒçŠ¶æ€æ˜¾ç¤º
- âœ… **å¹¶è¡Œæ‰§è¡Œ** - å……åˆ†åˆ©ç”¨ GitHub å…è´¹çš„å¹¶è¡Œèµ„æº

## ğŸ“Š **å¼€æºé¡¹ç›® CI æ¶æ„è®¾è®¡**

### ğŸš€ **æ™ºèƒ½åˆ†å±‚æ¶æ„**

```mermaid
graph TD
    A[Quick Check] --> B[Lint]
    A --> C[Test Matrix]
    A --> D[Compatibility]
    A --> E[Build Matrix]

    C --> F[Performance Tests]
    D --> F

    A --> G[Security Scan]

    F --> H[All Checks Complete]
    G --> H
    B --> H
    E --> H
```

### ğŸ”„ **æ‰§è¡Œç­–ç•¥**

1. **ç¬¬ä¸€å±‚ - å¿«é€Ÿæ£€æŸ¥** (1-2 åˆ†é’Ÿ)

   - Go æ ¼å¼æ£€æŸ¥
   - ä¾èµ–éªŒè¯
   - åŸºç¡€æ„å»º
   - go vet

2. **ç¬¬äºŒå±‚ - å¹¶è¡ŒéªŒè¯** (3-8 åˆ†é’Ÿ)

   - ä»£ç è´¨é‡æ£€æŸ¥ (golangci-lint)
   - æµ‹è¯•çŸ©é˜µ (Go 1.22, 1.23)
   - å…¼å®¹æ€§æµ‹è¯• (PostgreSQL 14, 15, 16)
   - è·¨å¹³å°æ„å»º (Linux, Windows, macOS)

3. **ç¬¬ä¸‰å±‚ - æ·±åº¦æ£€æŸ¥** (ä»… main åˆ†æ”¯)
   - æ€§èƒ½æµ‹è¯•
   - å®‰å…¨æ‰«æ
   - åŸºå‡†æµ‹è¯•

## âš¡ **ä¼˜åŒ–ç­–ç•¥è¯¦è§£**

### 1. **å¿«é€Ÿå¤±è´¥åŸåˆ™**

```yaml
# æœ€å…ˆè¿è¡Œæœ€å¯èƒ½å¤±è´¥çš„æ£€æŸ¥
quick-check:
  - go mod verify # ä¾èµ–é—®é¢˜
  - gofmt check # æ ¼å¼é—®é¢˜
  - go build # ç¼–è¯‘é—®é¢˜
  - go vet # åŸºç¡€ä»£ç é—®é¢˜
```

### 2. **æ™ºèƒ½å¹¶è¡ŒåŒ–**

```yaml
# å……åˆ†åˆ©ç”¨GitHub Actionsçš„å¹¶è¡Œèƒ½åŠ›
strategy:
  matrix:
    go-version: ['1.22', '1.23'] # Goç‰ˆæœ¬çŸ©é˜µ
    postgres-version: ['14', '15', '16'] # æ•°æ®åº“ç‰ˆæœ¬çŸ©é˜µ
    os: [ubuntu, windows, macos] # æ“ä½œç³»ç»ŸçŸ©é˜µ
```

### 3. **æ¡ä»¶æ‰§è¡Œ**

```yaml
# é¿å…åœ¨PRä¸­è¿è¡Œé‡å‹ä»»åŠ¡
if: github.ref == 'refs/heads/main'     # ä»…mainåˆ†æ”¯
if: matrix.go-version == '1.23'         # ä»…ç‰¹å®šç‰ˆæœ¬
```

### 4. **ç¼“å­˜ä¼˜åŒ–**

```yaml
# æœ€å¤§åŒ–ç¼“å­˜åˆ©ç”¨
- uses: actions/setup-go@v5
  with:
    cache: true # Goæ¨¡å—ç¼“å­˜

# å¯é€‰ï¼šè‡ªå®šä¹‰ç¼“å­˜
- uses: actions/cache@v4
  with:
    path: ~/.cache/golangci-lint
    key: golangci-lint-${{ runner.os }}-${{ hashFiles('**/*.go') }}
```

## ğŸ¨ **PR æ£€æŸ¥ä½“éªŒä¼˜åŒ–**

### âœ… **å¿…éœ€æ£€æŸ¥** (é˜»å¡åˆå¹¶)

- Quick Check
- Lint
- Test (Go 1.23 + PostgreSQL 16)
- Build (è‡³å°‘ Linux)

### ğŸ”„ **å¯é€‰æ£€æŸ¥** (ä¸é˜»å¡åˆå¹¶)

- å…¼å®¹æ€§æµ‹è¯•
- è·¨å¹³å°æ„å»º
- æ€§èƒ½æµ‹è¯• (ä»… main)
- å®‰å…¨æ‰«æ (ä»… main)

### ğŸ“‹ **çŠ¶æ€æ˜¾ç¤ºä¼˜åŒ–**

```yaml
# æ¸…æ™°çš„ä»»åŠ¡å‘½å
name: Test (Go ${{ matrix.go-version }})
name: Compatibility (PostgreSQL ${{ matrix.postgres-version }})
name: Build (${{ matrix.os }})
```

## ğŸš€ **å¼€æºé¡¹ç›®ç‰¹æ®Šä¼˜åŒ–**

### 1. **å¤šç‰ˆæœ¬æ”¯æŒ**

```yaml
# ç¡®ä¿å‘åå…¼å®¹æ€§
strategy:
  matrix:
    go-version: ['1.22', '1.23'] # å½“å‰å’Œä¸Šä¸€ä¸ªç‰ˆæœ¬
```

### 2. **è·¨å¹³å°æ„å»º**

```yaml
# ç¡®ä¿è·¨å¹³å°å…¼å®¹æ€§
strategy:
  matrix:
    os: [ubuntu-latest, windows-latest, macos-latest]
```

### 3. **ç¤¾åŒºå‹å¥½çš„é”™è¯¯ä¿¡æ¯**

```yaml
# æä¾›æ¸…æ™°çš„é”™è¯¯ä¿¡æ¯
- name: Check Go formatting
  run: |
    if [ "$(gofmt -s -l . | wc -l)" -gt 0 ]; then
      echo "The following files are not properly formatted:"
      gofmt -s -l .
      echo "Please run: gofmt -s -w ."
      exit 1
    fi
```

### 4. **æ–‡æ¡£ç”Ÿæˆ**

```yaml
# å¯é€‰ï¼šè‡ªåŠ¨ç”Ÿæˆæ–‡æ¡£
- name: Generate docs
  run: |
    go install golang.org/x/tools/cmd/godoc@latest
    # ç”ŸæˆAPIæ–‡æ¡£
```

## ğŸ“ˆ **æ€§èƒ½æŒ‡æ ‡ç›‘æ§**

### ğŸ¯ **å…³é”®æŒ‡æ ‡**

- **PR åé¦ˆæ—¶é—´**: ç›®æ ‡ < 5 åˆ†é’Ÿ (å¿…éœ€æ£€æŸ¥)
- **å®Œæ•´ CI æ—¶é—´**: ç›®æ ‡ < 15 åˆ†é’Ÿ (æ‰€æœ‰æ£€æŸ¥)
- **æˆåŠŸç‡**: ç›®æ ‡ > 95%
- **å¹¶è¡Œæ•ˆç‡**: æœ€å¤§åŒ–å¹¶è¡Œä»»åŠ¡æ•°

### ğŸ“Š **ç›‘æ§æ–¹æ³•**

```bash
# GitHub CLI æŸ¥çœ‹è¿è¡Œæ—¶é—´
gh run list --limit 10 --json conclusion,createdAt,updatedAt

# åˆ†æCIç“¶é¢ˆ
gh run view [RUN_ID] --log
```

## ğŸ”§ **è¿›ä¸€æ­¥ä¼˜åŒ–å»ºè®®**

### 1. **è‡ªå®šä¹‰ Actions**

```yaml
# åˆ›å»ºå¤åˆActionå‡å°‘é‡å¤
- uses: ./.github/actions/setup-go-env
  with:
    go-version: ${{ matrix.go-version }}
```

### 2. **é¢„æ„å»ºé•œåƒ**

```dockerfile
# ä½¿ç”¨é¢„è£…Goå·¥å…·çš„é•œåƒ
FROM golang:1.23-alpine
RUN go install github.com/golangci/golangci-lint/cmd/golangci-lint@latest
```

### 3. **æ™ºèƒ½è§¦å‘**

```yaml
# åŸºäºæ–‡ä»¶å˜æ›´çš„æ™ºèƒ½è§¦å‘
on:
  push:
    paths:
      - '**.go'
      - 'go.mod'
      - 'go.sum'
      - '.github/workflows/**'
```

### 4. **ç¤¾åŒºè´¡çŒ®ä¼˜åŒ–**

```yaml
# ä¸ºå¤–éƒ¨è´¡çŒ®è€…ä¼˜åŒ–
permissions:
  contents: read # æœ€å°æƒé™
  pull-requests: write # å…è®¸è¯„è®º
```

## ğŸ† **æœ€ä½³å®è·µæ€»ç»“**

1. **å¿«é€Ÿåé¦ˆä¼˜å…ˆ** - æœ€é‡è¦çš„æ£€æŸ¥æœ€å…ˆè¿è¡Œ
2. **å¹¶è¡Œæœ€å¤§åŒ–** - å……åˆ†åˆ©ç”¨å…è´¹å¹¶è¡Œèµ„æº
3. **æ¡ä»¶æ‰§è¡Œ** - é‡å‹ä»»åŠ¡åªåœ¨å¿…è¦æ—¶è¿è¡Œ
4. **æ¸…æ™°çŠ¶æ€** - è®©è´¡çŒ®è€…å®¹æ˜“ç†è§£ CI çŠ¶æ€
5. **æ¸è¿›å¼æ£€æŸ¥** - ä»å¿«åˆ°æ…¢ï¼Œä»ç®€å•åˆ°å¤æ‚
6. **ç¤¾åŒºå‹å¥½** - æä¾›æœ‰ç”¨çš„é”™è¯¯ä¿¡æ¯å’Œä¿®å¤å»ºè®®

è¿™ç§æ¶æ„æ—¢ä¿è¯äº†ä»£ç è´¨é‡ï¼Œåˆä¸ºè´¡çŒ®è€…æä¾›äº†è‰¯å¥½çš„å¼€å‘ä½“éªŒï¼ ğŸš€
