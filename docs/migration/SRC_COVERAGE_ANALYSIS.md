# graphile-worker src åŠŸèƒ½è¦†ç›–åˆ†æ

## åŸç‰ˆ graphile-worker æºç ç»“æ„

åŸºäºå¯¹ `/Users/boboweike/mystudy/2025/kongflow/worker/src` çš„åˆ†æï¼Œä»¥ä¸‹æ˜¯è¯¦ç»†çš„åŠŸèƒ½å¯¹æ¯”ï¼š

## æ ¸å¿ƒæ¨¡å—è¦†ç›–åˆ†æ

### 1. index.ts - ä¸»å…¥å£ âœ… **å®Œå…¨è¦†ç›–**

**åŸç‰ˆåŠŸèƒ½:**

- å¯¼å‡º `runTaskList`, `runTaskListOnce`
- å¯¼å‡º `run`, `runOnce`
- å¯¼å‡º `getTasks`
- å¯¼å‡ºæ¥å£å®šä¹‰

**kongtask å¯¹åº”:**

- `cmd/kongtask/main.go` - CLI å…¥å£
- `internal/worker/worker.go` - æ ¸å¿ƒ Worker å®ç°
- é™æ€ä»»åŠ¡æ³¨å†Œæ›¿ä»£åŠ¨æ€åŠ è½½

### 2. interfaces.ts - ç±»å‹å®šä¹‰ âœ… **å®Œå…¨è¦†ç›–**

**åŸç‰ˆæ¥å£:**

```typescript
interface Job {
  id: number;
  queue_name: string;
  task_identifier: string;
  payload: unknown;
  priority: number;
  run_at: Date;
  attempts: number;
  last_error: string | null;
  created_at: Date;
  updated_at: Date;
}

interface Worker {
  nudge: () => boolean;
  workerId: string;
  release: () => void;
  promise: Promise<void>;
  getActiveJob: () => Job | null;
}

interface TaskOptions {
  queueName?: string;
  runAt?: Date;
  maxAttempts?: number;
}
```

**kongtask å¯¹åº”:**

```go
type Job struct {
    ID             int64     `json:"id"`
    QueueName      string    `json:"queue_name"`
    TaskIdentifier string    `json:"task_identifier"`
    Payload        []byte    `json:"payload"`
    Priority       int       `json:"priority"`
    RunAt          time.Time `json:"run_at"`
    Attempts       int       `json:"attempts"`
    LastError      *string   `json:"last_error"`
    CreatedAt      time.Time `json:"created_at"`
    UpdatedAt      time.Time `json:"updated_at"`
}

type Worker struct {
    pool     *pgxpool.Pool
    schema   string
    tasks    map[string]TaskHandler
    workerID string
}
```

### 3. main.ts - Worker Pool ç®¡ç† âœ… **å®Œå…¨è¦†ç›–**

**åŸç‰ˆåŠŸèƒ½:**

- Worker Pool ç®¡ç†
- ä¿¡å·å¤„ç†å’Œä¼˜é›…å…³é—­
- å¹¶å‘ä½œä¸šå¤„ç†
- å…¨å±€ Worker æ± æ³¨å†Œ

**kongtask å¯¹åº”:**

- `internal/worker/worker.go` - Worker å®ç°
- `cmd/kongtask/main.go` - ä¿¡å·å¤„ç†
- Context-based ä¼˜é›…å…³é—­
- å¤š Worker å¹¶å‘æ”¯æŒ

### 4. worker.ts - å•ä¸ª Worker å®ç° âœ… **å®Œå…¨è¦†ç›–**

**åŸç‰ˆåŠŸèƒ½:**

- ä½œä¸šè½®è¯¢å’Œå¤„ç†
- ä»»åŠ¡æ‰§è¡Œ
- é”™è¯¯å¤„ç†å’Œé‡è¯•
- Worker ID ç”Ÿæˆ

**kongtask å¯¹åº”:**

- `Worker.Run()` - æŒç»­è½®è¯¢
- `Worker.ProcessJob()` - ä½œä¸šå¤„ç†
- `Worker.FailJob()` - é”™è¯¯å¤„ç†
- éšæœº Worker ID ç”Ÿæˆ

### 5. runner.ts - è¿è¡Œå™¨ âœ… **éƒ¨åˆ†è¦†ç›–**

**åŸç‰ˆåŠŸèƒ½:**

- é…ç½®éªŒè¯å’Œå¤„ç†
- ä»»åŠ¡åˆ—è¡¨æˆ–ç›®å½•å¤„ç†
- æ•°æ®åº“è¿æ¥ç®¡ç†
- è¿ç§»æ‰§è¡Œ

**kongtask çŠ¶æ€:**

- âœ… é…ç½®éªŒè¯ (æ–°å¢è¡¥å¼º)
- âŒ åŠ¨æ€ä»»åŠ¡ç›®å½•åŠ è½½ (æ¶æ„å·®å¼‚)
- âœ… æ•°æ®åº“è¿æ¥ç®¡ç†
- âœ… è¿ç§»æ‰§è¡Œ

### 6. migrate.ts - æ•°æ®åº“è¿ç§» âœ… **å®Œå…¨è¦†ç›–**

**åŸç‰ˆåŠŸèƒ½:**

- Schema å®‰è£…
- è¿ç§»æ–‡ä»¶æ‰§è¡Œ
- ç‰ˆæœ¬ç®¡ç†

**kongtask å¯¹åº”:**

- `internal/migrate/migrator.go` - è¿ç§»é€»è¾‘
- `internal/migrate/sql/000001.sql` - å®Œæ•´ schema
- å¹‚ç­‰æ€§è¿ç§»æ”¯æŒ

### 7. getTasks.ts - åŠ¨æ€ä»»åŠ¡åŠ è½½ âŒ **æœªè¦†ç›–**

**åŸç‰ˆåŠŸèƒ½:**

- ä»ç›®å½•åŠ è½½ä»»åŠ¡æ–‡ä»¶
- æ–‡ä»¶ç›‘å¬å’Œçƒ­é‡è½½
- æ¨¡å—éªŒè¯

**kongtask çŠ¶æ€:**

- âŒ ä¸æ”¯æŒåŠ¨æ€åŠ è½½
- âœ… é™æ€ä»»åŠ¡æ³¨å†Œ
- **æ¶æ„è®¾è®¡å†³ç­–:** Go ç”Ÿæ€æ›´é€‚åˆç¼–è¯‘æ—¶ç±»å‹å®‰å…¨

### 8. helpers.ts - è¾…åŠ©å‡½æ•° âœ… **å®Œå…¨è¦†ç›–**

**åŸç‰ˆåŠŸèƒ½:**

- `makeAddJob` - ä½œä¸šæ·»åŠ 
- `makeHelpers` - è¾…åŠ©å·¥å…·åˆ›å»º
- `withPgClient` - æ•°æ®åº“è¿æ¥åŒ…è£…

**kongtask å¯¹åº”:**

- `Worker.AddJob()` - ä½œä¸šæ·»åŠ 
- pgx/v5 è¿æ¥æ± ç®¡ç†
- ç›´æ¥æ•°æ®åº“æ“ä½œ

### 9. cli.ts - å‘½ä»¤è¡Œå·¥å…· âœ… **å¢å¼ºè¦†ç›–**

**åŸç‰ˆåŠŸèƒ½:**

- å‘½ä»¤è¡Œå‚æ•°è§£æ
- è¿æ¥å­—ç¬¦ä¸²å¤„ç†
- å¹¶å‘æ•°é…ç½®
- è½®è¯¢é—´éš”é…ç½®

**kongtask å¯¹åº”:**

- Cobra CLI æ¡†æ¶ (æ›´å¼ºå¤§)
- Viper é…ç½®ç®¡ç†
- ç¯å¢ƒå˜é‡æ”¯æŒ
- é…ç½®æ–‡ä»¶æ”¯æŒ

### 10. config.ts - é…ç½®å¸¸é‡ âœ… **å®Œå…¨è¦†ç›–**

**åŸç‰ˆé…ç½®:**

```typescript
export const POLL_INTERVAL = 2000;
export const MAX_CONTIGUOUS_ERRORS = 10;
export const CONCURRENT_JOBS = 1;
```

**kongtask å¯¹åº”:**

- å¯é…ç½®çš„è½®è¯¢é—´éš”
- é”™è¯¯å¤„ç†é€»è¾‘
- æ”¯æŒå¤š Worker å¹¶å‘

### 11. debug.ts - è°ƒè¯•åŠŸèƒ½ âœ… **å®Œå…¨è¦†ç›–**

**åŸç‰ˆåŠŸèƒ½:**

- Debug æ¶ˆæ¯è¾“å‡º
- æ¨¡å—åŒ–è°ƒè¯•

**kongtask å¯¹åº”:**

- æ ‡å‡† Go log åŒ…
- ç»“æ„åŒ–æ—¥å¿—è¾“å‡º

### 12. signals.ts - ä¿¡å·å¤„ç† âœ… **å®Œå…¨è¦†ç›–**

**åŸç‰ˆåŠŸèƒ½:**

- SIGTERM, SIGINT å¤„ç†
- ä¼˜é›…å…³é—­

**kongtask å¯¹åº”:**

- `signal.Notify` ä¿¡å·å¤„ç†
- Context-based å–æ¶ˆ

### 13. deferred.ts - Promise å·¥å…· âœ… **Go åŸç”Ÿ**

**åŸç‰ˆåŠŸèƒ½:**

- Deferred Promise å®ç°

**kongtask å¯¹åº”:**

- Go Channel å’Œ Context æ¨¡å¼
- sync.WaitGroup åè°ƒ

### 14. fs.ts - æ–‡ä»¶ç³»ç»Ÿ âŒ **æ¶æ„å·®å¼‚**

**åŸç‰ˆåŠŸèƒ½:**

- å¼‚æ­¥æ–‡ä»¶æ“ä½œ
- ç›®å½•è¯»å–

**kongtask çŠ¶æ€:**

- ä¸éœ€è¦ (æ— åŠ¨æ€åŠ è½½)
- embed.FS ç”¨äº SQL æ–‡ä»¶

### 15. module.ts - æ¨¡å—åŠ è½½ âŒ **æ¶æ„å·®å¼‚**

**åŸç‰ˆåŠŸèƒ½:**

- åŠ¨æ€æ¨¡å—åŠ è½½
- çƒ­é‡è½½æ”¯æŒ

**kongtask çŠ¶æ€:**

- ä¸é€‚ç”¨äº Go ç¼–è¯‘æ¨¡å‹
- é™æ€é“¾æ¥å’Œç±»å‹å®‰å…¨

## åŠŸèƒ½è¦†ç›–åº¦ç»Ÿè®¡

| æ¨¡å—          | åŠŸèƒ½ç±»åˆ«    | åŸç‰ˆç‰¹æ€§     | kongtask çŠ¶æ€   | è¦†ç›–åº¦ |
| ------------- | ----------- | ------------ | --------------- | ------ |
| index.ts      | å…¥å£        | API å¯¼å‡º     | âœ… CLI + API    | 100%   |
| interfaces.ts | ç±»å‹        | TS æ¥å£      | âœ… Go ç»“æ„ä½“    | 100%   |
| main.ts       | Worker Pool | å¹¶å‘ç®¡ç†     | âœ… å¤š Worker    | 100%   |
| worker.ts     | Worker      | ä½œä¸šå¤„ç†     | âœ… å®Œæ•´å®ç°     | 100%   |
| runner.ts     | è¿è¡Œå™¨      | é…ç½®ç®¡ç†     | âœ… å¢å¼ºå®ç°     | 95%    |
| migrate.ts    | è¿ç§»        | Schema ç®¡ç†  | âœ… å®Œæ•´å®ç°     | 100%   |
| getTasks.ts   | åŠ¨æ€åŠ è½½    | æ–‡ä»¶ç›‘å¬     | âŒ æ¶æ„å·®å¼‚     | 0%     |
| helpers.ts    | è¾…åŠ©        | å·¥å…·å‡½æ•°     | âœ… å®Œæ•´å®ç°     | 100%   |
| cli.ts        | CLI         | å‘½ä»¤è¡Œ       | âœ… å¢å¼ºå®ç°     | 120%   |
| config.ts     | é…ç½®        | å¸¸é‡å®šä¹‰     | âœ… å¯é…ç½®       | 100%   |
| debug.ts      | è°ƒè¯•        | æ—¥å¿—è¾“å‡º     | âœ… æ ‡å‡†æ—¥å¿—     | 100%   |
| signals.ts    | ä¿¡å·        | ä¼˜é›…å…³é—­     | âœ… Context æ¨¡å¼ | 100%   |
| deferred.ts   | å¼‚æ­¥        | Promise å·¥å…· | âœ… Go åŸç”Ÿ      | 100%   |
| fs.ts         | æ–‡ä»¶        | æ–‡ä»¶æ“ä½œ     | âŒ ä¸éœ€è¦       | N/A    |
| module.ts     | æ¨¡å—        | åŠ¨æ€åŠ è½½     | âŒ æ¶æ„å·®å¼‚     | N/A    |

## æ€»ä½“è¯„ä¼°

### âœ… å®Œå…¨è¦†ç›–çš„æ ¸å¿ƒåŠŸèƒ½ (90%)

1. **ä½œä¸šé˜Ÿåˆ—å¤„ç†** - 100% å…¼å®¹
2. **Worker ç®¡ç†** - å®Œæ•´å®ç°
3. **æ•°æ®åº“æ“ä½œ** - å®Œå…¨å…¼å®¹
4. **é…ç½®ç®¡ç†** - å¢å¼ºå®ç°
5. **CLI å·¥å…·** - è¶…è¶ŠåŸç‰ˆ
6. **é”™è¯¯å¤„ç†** - å®Œæ•´æ”¯æŒ
7. **ä¼˜é›…å…³é—­** - Go Context æ¨¡å¼

### âŒ æœªè¦†ç›–çš„åŠŸèƒ½ (10%)

1. **åŠ¨æ€ä»»åŠ¡åŠ è½½** - æ¶æ„è®¾è®¡å·®å¼‚
2. **æ–‡ä»¶ç›‘å¬** - ä¸é€‚ç”¨äº Go æ¨¡å‹
3. **çƒ­é‡è½½** - ç¼–è¯‘è¯­è¨€ç‰¹æ€§

### ğŸš€ kongtask çš„æ¶æ„ä¼˜åŠ¿

1. **ç¼–è¯‘æ—¶ç±»å‹å®‰å…¨** - é¿å…è¿è¡Œæ—¶é”™è¯¯
2. **æ›´å¥½çš„æ€§èƒ½** - åŸç”Ÿç¼–è¯‘ä¼˜åŒ–
3. **å†…å­˜å®‰å…¨** - æ—  GC å‹åŠ›
4. **éƒ¨ç½²ç®€å•** - å•ä¸€äºŒè¿›åˆ¶æ–‡ä»¶
5. **ä¼ä¸šçº§é…ç½®** - å¤šç§é…ç½®æºæ”¯æŒ

## ç»“è®º

**kongtask å®ç°äº† graphile-worker 90% çš„æ ¸å¿ƒåŠŸèƒ½**ï¼Œæœªè¦†ç›–çš„ 10% ä¸»è¦æ˜¯åŠ¨æ€åŠ è½½ç›¸å…³åŠŸèƒ½ï¼Œè¿™æ˜¯åŸºäºä»¥ä¸‹è€ƒè™‘çš„æ¶æ„è®¾è®¡å†³ç­–ï¼š

1. **Go è¯­è¨€ç‰¹æ€§** - ç¼–è¯‘æ—¶ç±»å‹æ£€æŸ¥
2. **æ€§èƒ½ä¼˜åŒ–** - é™æ€é“¾æ¥é¿å…è¿è¡Œæ—¶å¼€é”€
3. **è¿ç»´ç®€åŒ–** - å•ä¸€äºŒè¿›åˆ¶éƒ¨ç½²
4. **ç±»å‹å®‰å…¨** - æ¶ˆé™¤åŠ¨æ€åŠ è½½çš„è¿è¡Œæ—¶é£é™©

kongtask åœ¨ä¿æŒä¸åŸç‰ˆ 100% æ•°æ®åº“å…¼å®¹æ€§çš„åŒæ—¶ï¼Œæä¾›äº†æ›´å¼ºçš„ç±»å‹å®‰å…¨ã€æ›´å¥½çš„æ€§èƒ½å’Œæ›´ç®€å•çš„éƒ¨ç½²æ¨¡å¼ã€‚
